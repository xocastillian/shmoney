# AGENTS

Этот файл описывает ключевые особенности проекта **shmoney** и служит инструкцией для задания задач агенту.

## Архитектура
- Бэкенд построен на Spring Boot 3.3 с Java 21, модульная структура: `auth`, `wallet`, `transaction`, `category`, `budget`, `analytics`, `currency`, `settings`, `publicapi`.
- DTO реализованы через Java records, сопоставление сущностей/ответов делается MapStruct‑мапперами.
- Входные данные валидируются Jakarta Validation аннотациями.
- Основной стек: Spring Web + Security + Data JPA, Flyway для миграций, SpringDoc для Swagger, Caffeine для кеша курсов валют.

## Доменные области
- **Auth** — логин через Telegram WebApp initData, выдача JWT access/refresh токенов, работа с HTTP‑only куками (`TokenCookieService`).
- **Wallet** — CRUD кошельков (цвет, валюта, баланс, тип, debet/credit), операции перевода между кошельками, агрегация балансов.
- **Category & Transactions** — дерево категорий (статусы ACTIVE/ARCHIVED) и доход/расход трансакции, пересчёт балансов кошельков и бюджетов.
- **Budgets** — бюджеты с периодами (MONTH/WEEK/YEAR/CUSTOM), персистентная связка с категориями, сервис `BudgetSpendingService` пересчитывает траты.
- **Analytics** — помесячные сводки в таблице `analytics_monthly_summary`, сервис `AnalyticsService` строит кэш и обновляет данные по расписанию.
- **Currency** — хранение курсов, обращение к внешнему API через `ExchangeRateClient`, кеширование через Caffeine.
- **Settings** — глобальные настройки приложения (язык, валюты), загружаются через `AppSettingsProvider`.
- **Public API** — `/api/public/ping` для проверки доступности без авторизации.

## База данных и миграции
- Миграции Flyway хранятся в `src/main/resources/db/migration`, их нужно добавлять в порядке версии (`VXX__name.sql`).
- Все денежные суммы и балансы хранятся как TEXT и шифруются через `EncryptedBigDecimalConverter`; при добавлении новых сумм обязательно использовать этот конвертер.
- Таблица `wallets` содержит обязательные поля `type` и `debet_or_credit` (в AGENTS актуализировано требование: все существующие кошельки имеют `debet_or_credit=DEBET`).
- При изменении схемы не забывать обновлять сущности, DTO и MapStruct‑мапперы.
- Если необходимы данные в Java‑миграции, помещать их в `src/main/java/db/migration`.

## Безопасность и инфраструктура
- Аутентификация только через JWT + `JwtAuthenticationFilter`; любые новые публичные эндпоинты должны быть явно разрешены в `SecurityConfig`.
- Авторизация: всегда проверяйте владение ресурсом (пример в `WalletController.ensureCanAccess`).
- Все суммы/балансы переписываются в кошельке при каждой операции через `WalletService`/`CategoryTransactionService`/`WalletTransactionService` — придерживайтесь текущих паттернов.
- Для логирования входящих запросов используется `RequestLoggingFilter`; избегайте дублирующих логов там же.
- Свойства читаются через `.env` (см. `application.properties`), при добавлении новых переменных описывайте их там и в `docker-compose` при необходимости.

## Деплой и окружение
- Dockerfile — двухэтапная сборка (Maven build + Temurin JRE). В compose поднимаются `postgres`, `app`, `nginx`, `frontend`, плюс вспомогательные профили для сертификатов.
- Nginx проксирует `app` и `frontend`, сертификаты лежат во внешних томах (`letsencrypt`, `certbot-webroot`).
- Любые изменения, связанные с TLS/доменами, отражайте в `deploy/nginx/templates/*.conf.template`.

## Правила разработки
- Соблюдайте существующий стиль кода (Java, 4 пробела, без внутренних комментариев). Новые классы и поля документируйте говорящими именами.
- При создании REST‑эндпоинтов используйте аннотации OpenAPI (Tag/Operation) по аналогии с существующими контроллерами.
- Все числовые суммы/балансы должны храниться как `BigDecimal` с приводом к масштабу 2 и шифрованием.
- Для сериализации новых enum‑значений, которые выходят в API, обеспечивайте корректный JSON (пример `DebetOrCredit`).
- После изменений сущностей/DTO обновляйте MapStruct мапперы и записи в ответах.
- В задачах, затрагивающих аналитику или бюджеты, не забывайте инвалидировать кэш/снапшоты (`AnalyticsService.invalidateMonth`, `BudgetSpendingService`).

Это базовый контекст проекта; при постановке задач можно ссылаться на данный файл, чтобы не повторять описание архитектуры.
