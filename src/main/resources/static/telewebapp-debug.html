<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>Telegram initData debug</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background:#0f172a; color:#f8fafc; }
        main { max-width: 760px; margin: 0 auto; display: grid; gap: 18px; }
        header { display:flex; align-items:center; justify-content:space-between; }
        h1 { margin:0; font-size: 22px; }
        button { padding: 10px 16px; border-radius: 12px; border:none; background:#2563eb; color:white; font-size:14px; cursor:pointer; transition:all .2s ease; }
        button:disabled { background:#475569; cursor:not-allowed; }
        pre { white-space: pre-wrap; word-break: break-word; background:rgba(148,163,184,.15); padding:14px; border-radius:12px; }
        .log { font-size:12px; opacity:.7; }
        footer { font-size:13px; color:#94a3b8; }
    </style>
</head>
<body>
<main>
    <header>
        <h1>Telegram initData</h1>
        <button id="copy" disabled>Скопировать</button>
    </header>
    <section>
        <p>Откройте страницу внутри Telegram Mini App. Здесь отобразится исходный <code>initData</code> (он действует пару минут). Скопируйте строку и отправьте её на <code>POST /api/auth/telegram</code>.</p>
    </section>
    <pre id="output">Ожидание WebApp API…</pre>
    <pre class="log" id="log"></pre>
    <footer>Если видите «WebApp API недоступен», откройте страницу через бота, а не в браузере.</footer>
</main>

<script>
    const out = document.getElementById('output');
    const copyBtn = document.getElementById('copy');
    const logEl = document.getElementById('log');
    const webApp = window.Telegram?.WebApp;

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.textContent += `[${time}] ${msg}\n`;
    }

    if (!webApp) {
        out.textContent = 'WebApp API недоступен. Откройте страницу внутри Telegram.';
        log('Telegram.WebApp не найден');
    } else {
        log('WebApp API готов');
        try {
            webApp.ready();
            const data = webApp.initData || '';
            out.textContent = data || 'initData пустой';
            copyBtn.disabled = !data;
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(data);
                    copyBtn.textContent = 'Скопировано!';
                    setTimeout(() => copyBtn.textContent = 'Скопировать', 2000);
                    log('initData скопирован в буфер');
                } catch (err) {
                    copyBtn.textContent = 'Не удалось скопировать';
                    log('Ошибка копирования: ' + err.message);
                }
            });
        } catch (err) {
            out.textContent = 'Ошибка инициализации WebApp: ' + err.message;
            log('Ошибка WebApp: ' + err.message);
        }
    }
</script>
</body>
</html>
